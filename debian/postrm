#!/bin/bash

set -e

. /usr/share/debconf/confmodule

# unHide deprecated window decorations
function show_deprecated {
    if [ -e /usr/share/netrunner/hidden/kwin_b2_config.so ]; then
      dpkg-divert --package netrunner-default-settings --remove --rename --divert /usr/share/netrunner/hidden/kwin_b2_config.so /usr/lib/kde4/kwin_b2_config.so 
    fi
    if [ -e /usr/share/netrunner/hidden/kwin3_b2.so ]; then
      dpkg-divert --package netrunner-default-settings --remove --rename --divert /usr/share/netrunner/hidden/kwin3_b2.so /usr/lib/kde4/kwin3_b2.so 
    fi
    if [ -e /usr/share/netrunner/hidden/kwin3_laptop.so ]; then
      dpkg-divert --package netrunner-default-settings --remove --rename --divert /usr/share/netrunner/hidden/kwin3_laptop.so /usr/lib/kde4/kwin3_laptop.so 
    fi
    if [ -e /usr/share/netrunner/hidden/plastik_metadata.desktop ]; then
      dpkg-divert --package netrunner-default-settings --remove --rename --divert /usr/share/netrunner/hidden/plastik_metadata.desktop /usr/share/kde4/apps/kwin/decorations/kwin4_decoration_qml_plastik/metadata.desktop
    fi
    if [ -e /usr/share/netrunner/hidden/plastik_main.qml ]; then
      dpkg-divert --package netrunner-default-settings --remove --rename --divert /usr/share/netrunner/hidden/plastik_main.qml /usr/share/kde4/apps/kwin/decorations/kwin4_decoration_qml_plastik/contents/ui/main.qml
    fi
    if [ -e /usr/share/netrunner/hidden/libplastikplugin.so ]; then
      dpkg-divert --package netrunner-default-settings --remove --rename --divert /usr/share/netrunner/hidden/libplastikplugin.so /usr/lib/kde4/imports/org/kde/kwin/decorations/plastik/libplastikplugin.so 
    fi
    if [ -e /usr/share/netrunner/hidden/oxy-yellow_index.theme ]; then
      dpkg-divert --package netrunner-default-settings --remove --rename --divert /usr/share/netrunner/hidden/oxy-yellow_index.theme /usr/share/icons/oxy-yellow/index.theme 
    fi
    if [ -e /usr/share/netrunner/hidden/oxy-zion_index.theme ]; then
      dpkg-divert --package netrunner-default-settings --remove --rename --divert /usr/share/netrunner/hidden/oxy-zion_index.theme /usr/share/icons/oxy-zion/index.theme
    fi
    # Show hidden pulseaudio.desktop in autostart
    if [ -e /usr/share/netrunner/hidden/pulseaudio.desktop ]; then
      dpkg-divert --package netrunner-default-settings --remove --rename --divert /usr/share/netrunner/hidden/pulseaudio.desktop /etc/xdg/autostart/pulseaudio.desktop
    fi
    # Show cashew/hamburger
    if [ -e /usr/share/plasma/packages/org.kde.desktoptoolbox/metadata.desktop ]; then 
      dpkg-divert --package netrunner-default-settings --remove --rename --divert /usr/share/netrunner/hidden/desktoptoolbox_metadata.desktop /usr/share/plasma/packages/org.kde.desktoptoolbox/metadata.desktop
    fi
    # Hide cashew/hamburger QML UI
    if [ -e /usr/share/plasma/packages/org.kde.desktoptoolbox/contents/ui/ToolBoxRoot.qml ]; then
      dpkg-divert --package netrunner-default-settings --remove --rename --divert /usr/share/netrunner/hidden/desktoptoolbox_ToolBoxRoot.qml /usr/share/plasma/packages/org.kde.desktoptoolbox/contents/ui/ToolBoxRoot.qml
    fi
    # Show pulseaudio kcm (non working currently)
    if  [ -e /usr/share/kservices5/kcm_pulseaudio.desktop ]; then
      dpkg-divert --package netrunner-default-settings --remove --rename --divert /usr/share/netrunner/hidden/kcm_pulseaudio.desktop /usr/share/kservices5/kcm_pulseaudio.desktop
    fi
}

# Undo Diversions
function undo_diversions {
    # Firefox (instead of old adjust.py script)
    if [ -e /usr/lib/firefox/distribution/distribution.ini.orig ]; then
      dpkg-divert --package netrunner-default-settings --remove --rename --divert /usr/lib/firefox/distribution/distribution.ini.orig /usr/lib/firefox/distribution/distribution.ini
    fi
    # kactivitymanager_file_item_linking_plugin
    if [ -e /usr/share/kservices5/kactivitymanagerd_fileitem_linking_plugin.desktop.orig ]; then
      dpkg-divert --package netrunner-default-settings --remove --rename --divert /usr/share/kservices5/kactivitymanagerd_fileitem_linking_plugin.desktop.orig /usr/share/kservices5/kactivitymanagerd_fileitem_linking_plugin.desktop
    fi
    # gmusicbrowser layout
    if [ -e /usr/share/gmusicbrowser/layouts/main.layout.orig ]; then
      dpkg-divert --package netrunner-default-settings --remove --rename --divert /usr/share/gmusicbrowser/layouts/main.layout.orig /usr/share/gmusicbrowser/layouts/main.layout
    fi
    if [ -e /usr/share/gmusicbrowser/layouts/filterfun.layout.orig ]; then
      dpkg-divert --package netrunner-default-settings --remove --rename --divert /usr/share/gmusicbrowser/layouts/filterfun.layout.orig /usr/share/gmusicbrowser/layouts/filterfun.layout
    fi
    if [ -e /usr/share/gmusicbrowser/layouts/contrib.layout.orig ]; then
      dpkg-divert --package netrunner-default-settings --remove --rename --divert /usr/share/gmusicbrowser/layouts/contrib.layout.orig /usr/share/gmusicbrowser/layouts/contrib.layout
    fi
    if [ -e /usr/share/gmusicbrowser/layouts/makeitlooklike.layout.orig ]; then
      dpkg-divert --package netrunner-default-settings --remove --rename --divert /usr/share/gmusicbrowser/layouts/makeitlooklike.layout.orig /usr/share/gmusicbrowser/layouts/makeitlooklike.layout
    fi
    if [ -e /usr/share/gmusicbrowser/layouts/shimmer.layout.orig ]; then
      dpkg-divert --package netrunner-default-settings --remove --rename --divert /usr/share/gmusicbrowser/layouts/shimmer.layout.orig /usr/share/gmusicbrowser/layouts/shimmer.layout
    fi
    # gmusicbrowser main config file
    if [ -e /usr/share/gmusicbrowser/gmbrc.default.orig ]; then
      dpkg-divert --package netrunner-default-settings --remove --rename --divert /usr/share/gmusicbrowser/gmbrc.default.orig /usr/share/gmusicbrowser/gmbrc.default
    fi
}

case "$1" in
    remove|purge)
        #These files may have been created during installation
        rm -f /root/.gtkrc-2.0
        rm -f /root/.gtkrc-2.0-kde4
        rm -f /root/.config/gtk-3.0/settings.ini
        rm -f /etc/skel/.gtkrc-2.0
        rm -f /etc/skel/.gtkrc-2.0-kde4
        rm -f /etc/skel/.config/gtk-3.0/settings.ini
        show_deprecated
        undo_diversions
    ;;

    upgrade|abort-upgrade|abort-remove|abort-deconfigure)

    ;;

    *)
        echo "postrm called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

#DEBHELPER#

exit 0
